name: Facebook AI Bot Auto-Setup
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Unzip and Install Dependencies
        run: |
          unzip bot.zip
          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ù„Ù package.json ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„ÙŠÙ‡
          TARGET_DIR=$(find . -name "package.json" -exec dirname {} \; | head -n 1)
          cd $TARGET_DIR
          # ØªØ«Ø¨ÙŠØª ÙƒÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ø¨ÙˆØª + Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
          npm install
          npm install axios

      - name: Inject AI Logic
        run: |
          # Ø­Ù‚Ù† Ù…Ù†Ø·Ù‚ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙÙŠ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„ØµØ­ÙŠØ­
          TARGET_DIR=$(find . -name "package.json" -exec dirname {} \; | head -n 1)
          cat << 'AI' > $TARGET_DIR/ai_logic.js
          const axios = require('axios');
          async function getReply(text) {
            try {
              const r = await axios.post('https://openrouter.ai/api/v1/chat/completions', {
                model: 'openai/gpt-3.5-turbo',
                messages: [{role: 'user', content: text}]
              }, {
                headers: { Authorization: 'Bearer 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' }
              });
              return r.data.choices[0].message.content;
            } catch (e) { return "ğŸ¤– Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ"; }
          }
          module.exports = { getReply };
          AI
          # Ù†Ù‚Ù„ Ù…Ù„Ù Ø§Ù„ÙƒÙˆÙƒÙŠØ² Ù„Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„ØµØ­ÙŠØ­ Ù„ÙƒÙŠ ÙŠØ±Ø§Ù‡ Ø§Ù„Ø¨ÙˆØª
          cp appstate.json $TARGET_DIR/

      - name: Start Facebook Bot
        run: |
          TARGET_DIR=$(find . -name "package.json" -exec dirname {} \; | head -n 1)
          cd $TARGET_DIR
          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„Ù Ø§Ù„ØªØ´ØºÙŠÙ„ (ØºØ§Ù„Ø¨Ø§Ù‹ index.js)
          FILE=$(find . -maxdepth 1 -name "index.js" -o -name "main.js" | head -n 1)
          node $FILE
